"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const core_utils_1 = require("@electron-forge/core-utils");
const debug_1 = __importDefault(require("debug"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const forge_config_1 = require("./forge-config");
const read_package_json_1 = require("./read-package-json");
const d = (0, debug_1.default)('electron-forge:project-resolver');
// FIXME: If we want getElectronVersion to be overridable by plugins
//        and / or forge config then we need to be able to resolve
//        the dir without calling getElectronVersion
exports.default = async (dir) => {
    let mDir = path_1.default.resolve(dir);
    let bestGuessDir = null;
    let lastError = null;
    let prevDir;
    while (prevDir !== mDir) {
        prevDir = mDir;
        d('searching for project in:', mDir);
        if (forge_config_1.registeredForgeConfigs.has(mDir)) {
            d('virtual config found in:', mDir);
            return mDir;
        }
        const testPath = path_1.default.resolve(mDir, 'package.json');
        if (await fs_extra_1.default.pathExists(testPath)) {
            const packageJSON = await (0, read_package_json_1.readRawPackageJson)(mDir);
            // TODO: Move this check to inside the forge config resolver and use
            //       mutatedPackageJson reader
            try {
                await (0, core_utils_1.getElectronVersion)(mDir, packageJSON);
            }
            catch (err) {
                if (err instanceof Error) {
                    lastError = err.message;
                }
            }
            if (packageJSON.config && packageJSON.config.forge) {
                d('electron-forge compatible package.json found in', testPath);
                return mDir;
            }
            if (packageJSON.devDependencies?.['@electron-forge/cli'] || packageJSON.devDependencies?.['@electron-forge/core']) {
                d('package.json with forge dependency found in', testPath);
                return mDir;
            }
            bestGuessDir = mDir;
        }
        mDir = path_1.default.dirname(mDir);
    }
    if (bestGuessDir) {
        d('guessing on the best electron-forge package.json found in', bestGuessDir);
        return bestGuessDir;
    }
    if (lastError) {
        throw new Error(lastError);
    }
    return null;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZS1kaXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC9yZXNvbHZlLWRpci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGdEQUF3QjtBQUV4QiwyREFBZ0U7QUFDaEUsa0RBQTBCO0FBQzFCLHdEQUEwQjtBQUUxQixpREFBd0Q7QUFDeEQsMkRBQXlEO0FBRXpELE1BQU0sQ0FBQyxHQUFHLElBQUEsZUFBSyxFQUFDLGlDQUFpQyxDQUFDLENBQUM7QUFFbkQsb0VBQW9FO0FBQ3BFLGtFQUFrRTtBQUNsRSxvREFBb0Q7QUFDcEQsa0JBQWUsS0FBSyxFQUFFLEdBQVcsRUFBMEIsRUFBRTtJQUMzRCxJQUFJLElBQUksR0FBRyxjQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzdCLElBQUksWUFBWSxHQUFrQixJQUFJLENBQUM7SUFDdkMsSUFBSSxTQUFTLEdBQWtCLElBQUksQ0FBQztJQUVwQyxJQUFJLE9BQU8sQ0FBQztJQUNaLE9BQU8sT0FBTyxLQUFLLElBQUksRUFBRTtRQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLDJCQUEyQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQUkscUNBQXNCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3BDLENBQUMsQ0FBQywwQkFBMEIsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNwQyxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDcEQsSUFBSSxNQUFNLGtCQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ2pDLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBQSxzQ0FBa0IsRUFBQyxJQUFJLENBQUMsQ0FBQztZQUVuRCxvRUFBb0U7WUFDcEUsa0NBQWtDO1lBQ2xDLElBQUk7Z0JBQ0YsTUFBTSxJQUFBLCtCQUFrQixFQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQzthQUM3QztZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLElBQUksR0FBRyxZQUFZLEtBQUssRUFBRTtvQkFDeEIsU0FBUyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUM7aUJBQ3pCO2FBQ0Y7WUFFRCxJQUFJLFdBQVcsQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUU7Z0JBQ2xELENBQUMsQ0FBQyxpREFBaUQsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDL0QsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUVELElBQUksV0FBVyxDQUFDLGVBQWUsRUFBRSxDQUFDLHFCQUFxQixDQUFDLElBQUksV0FBVyxDQUFDLGVBQWUsRUFBRSxDQUFDLHNCQUFzQixDQUFDLEVBQUU7Z0JBQ2pILENBQUMsQ0FBQyw2Q0FBNkMsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDM0QsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUVELFlBQVksR0FBRyxJQUFJLENBQUM7U0FDckI7UUFDRCxJQUFJLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUMzQjtJQUNELElBQUksWUFBWSxFQUFFO1FBQ2hCLENBQUMsQ0FBQywyREFBMkQsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUM3RSxPQUFPLFlBQVksQ0FBQztLQUNyQjtJQUNELElBQUksU0FBUyxFQUFFO1FBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUM1QjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyxDQUFDIn0=